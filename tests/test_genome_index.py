import pytest

@pytest.fixture
def index_dir():
    from gimmemotifs.genome_index import GenomeIndex
    test_index_dir = 'tests/data/index/'
    g = GenomeIndex()
    g.create_index('tests/data/genome/', test_index_dir)

    return test_index_dir

@pytest.fixture
def loc_and_seq():
    return ("scaffold_54", 141483, 141492, "+"), "GTCTATGGG"

@pytest.fixture
def db(tmpdir, index_dir):
    from pita.annotationdb import AnnotationDb
    conn = "sqlite:///{}/pita_test_database.db".format(tmpdir)
    db = AnnotationDb(conn=conn,
            new=True,
            index=index_dir)
    return db

@pytest.fixture
def collection(db):
    from pita.dbcollection import DbCollection
    from pita.io import read_bed_transcripts

    bed = "tests/data/scaffold_54_genes.bed"
    for tname, source, exons in read_bed_transcripts(open(bed), "test", 0):
        db.add_transcript("{0}{1}{2}".format("test", ":::", tname), source, exons)
    
    mc = DbCollection(db, [])
    return mc

@pytest.fixture
def seqs():
    seqs = [
"CAGGAAGTCACGGAGCGCGGGATTTTTCAATCAGACTGATGAACAGATGAATACGACGAAGAGCATGGAGGCAATTCTGGAATTTTTTGTGCTGTGTGATCCAAAGAAGCGGCCAGTCAGACTGAACCGGTTGCCTTCTGTACCAAAGGATGCACTGTGTTATTCTGCCCTGCTGCCATCTCCTCTACCATCCCAGCTGTTGATCTTTGGCTTAGGTGACTGGTCAGGGTTATCTGGAGGAAGCACAGTAGAAGTGAAATTGGAAGGAAGTGGAACCAAAGAGCACAGACTGGGAACGCTGACTCCTGAGTCAAGATGCTTCCTGTGGGAATCTGACCAAAACCCCGACACCAGCATAATGTTACAAGAGGGAAAGCTGCATATCTGCATGTCGGTTAAAGGGCAGGTCAATATTAATTCTACTAACAGGAAAAAAGAGCATGGAAAGCGCAAGAGAATTAAAGAGGAAGAGGAAAATGTTTGTCCAAATAGTGGACATGTAAAAGTGCCTGCTCAAAAACAGAAGAACAGTAGTCCTAAGAGTCCAGCACCAGCAAAGCAACTTGCTCATTCTAAGGCCTTTTTAGCAGCACCAGCTGTGCCAACTGCACGCTGGGGTCAAGCGCTCTGTCCTGTCAACTCTGAGACAGTAATCTTGATTGGTGGACAGGGAACACGTATGCAGTTCTGTAAGGATTCCATGTGGAAACTGAATACAGATAGGAGCACATGGACTCCAGCTGAGGCATTGGCAGATGGCCTTTCACCAGAAGCTCGTACTGGGCACACAGCAACCTTCGATCCTGAGAACAACCGTATTTATGTGTTTGGAGGTTCTAAGAACAGAAAATGGTTCAATGATGTACATATTTTGGACATTGAGGCCTGGCGATGGAGGAGCGTGGAAGTAAGTAAACTAAGTAGTTGA",
"CAGGAAGTCACGGAGCGCGGGATTTTTCAATCAGACTGATGAACAGATGAATACGACGAAGAGCATGGAGGCAATTCTGGAATTTTTTGTGCTGTGTGATCCAAAGAAGCGGCCAGTCAGACTGAACCGGTTGCCTTCTGTACCAAAGGATGCACTGTGTTATTCTGCCCTGCTGCCATCTCCTCTACCATCCCAGCTGTTGATCTTTGGCTTAGGTGACTGGTCAGGGTTATCTGGAGGAAGCACAGTAGAAGTGAAATTGGAAGGAAGTGGAACCAAAGAGCACAGACTGGGAACGCTGACTCCTGAGTCAAGATGCTTCCTGTGGGAATCTGACCAAAACCCCGACACCAGCATAATGTTACAAGAGGGAAAGCTGCATATCTGCATGTCGGTTAAAGGGCAGGTCAATATTAATTCTACTAACAGGAAAAAAGAGCATGGAAAGCGCAAGAGAATTAAAGAGGAAGAGGAAAATGTTTGTCCAAATAGTGGACATGTAAAAGTGCCTGCTCAAAAACAGAAGAACAGTAGTCCTAAGAGTCCAGCACCAGCAAAGCAACTTGCTCATTCTAAGGCCTTTTTAGCAGCACCAGCTGTGCCAACTGCACGCTGGGGTCAAGCGCTCTGTCCTGTCAACTCTGAGACAGTAATCTTGATTGGTGGACAGGGAACACGTATGCAGTTCTGTAAGGATTCCATGTGGAAACTGAATACAGATAGGAGCACATGGACTCCAGCTGAGGCATTGGCAGATGGCCTTTCACCAGAAGCTCGTACTGGGCACACAGCAACCTTCGATCCTGAGAACAACCGTATTTATGTGTTTGGAGGTTCTAAGAACAGAAAATGGTTCAATGATGTACATATTTTGGACATTGAGGCCTGGCGATGGAGGAGCGTGGAAGCACAGGGCAAAGTTCCCCCTCTCTCTTATCATACGTGCTCTCTGTTTCGAGGAGAGCTCTTTGTGTTTGGTGGGGTCTTTCCACGTCCTAATCCTGAACCTGATGGCTGCAGCAATTTACTCTACATTTTTGATCCGCAACATGAGATTTGGTACCAGCCTATTGTCCTAGGAAAGACCCCTTCGTCACGCTCAGGGTAAGCAGGAGAGGCATTTAGAGCAGAACAGAGTCTATAATCCTTTGGGAAATGAGTCAGGAGAGCATGTGGTTCATTTTCACAAGTGATGATGCCACCCTTAAATCAATCTGTAACTATAAGTTTTAGAGGAGATGCAAGTGCCTATTTATATTAATAACTAAATCTTTTTTGTGTTTTGTGTATAAAAACATAGTAAGTTAGGTTGAAAAAAAGATGTACGTACTGTTACCCTCCCCCCCCTTTTTTTTTTGTTACCC",
"CAGGAAGTCACGGAGCGCGGGATTTTTCAATCAGACTGATGAACAGATGAATACGACGAAGAGCATGGAGGCAATTCTGGAATTTTTTGTGCTGTGTGATCCAAAGAAGCGGCCAGTCAGACTGAACCGGTTGCCTTCTGTACCAAAGGATGCACTGTGTTATTCTGCCCTGCTGCCATCTCCTCTACCATCCCAGCTGTTGATCTTTGGCTTAGGTGACTGGTCAGGGTTATCTGGAGGAAGCACAGTAGAAGTGAAATTGGAAGGAAGTGGAACCAAAGAGCACAGACTGGGAACGCTGACTCCTGAGTCAAGATGCTTCCTGTGGGAATCTGACCAAAACCCCGACACCAGCATAATGTTACAAGAGGGAAAGCTGCATATCTGCATGTCGGTTAAAGGGCAGGTCAATATTAATTCTACTAACAGGAAAAAAGAGCATGGAAAGCGCAAGAGAATTAAAGAGGAAGAGGAAAATGTTTGTCCAAATAGTGGACATGTAAAAGTGCCTGCTCAAAAACAGAAGAACAGTAGTCCTAAGAGTCCAGCACCAGCAAAGCAACTTGCTCATTCTAAGGCCTTTTTAGCAGCACCAGCTGTGCCAACTGCACGCTGGGGTCAAGCGCTCTGTCCTGTCAACTCTGAGACAGTAATCTTGATTGGTGGACAGGGAACACGTATGCAGTTCTGTAAGGATTCCATGTGGAAACTGAATACAGATAGGAGCACATGGACTCCAGCTGAGGCATTGGCAGATGGCCTTTCACCAGAAGCTCGTACTGGGCACACAGCAACCTTCGATCCTGAGAACAACCGTATTTATGTGTTTGGAGGTTCTAAGAACAGAAAATGGTTCAATGATGTACATATTTTGGACATTGAGGCCTGGCGATGGAGGAGCGTGGAAGCACAGGGCAAAGTTCCCCCTCTCTCTTATCATACGTGCTCTCTGTTTCGAGGAGAGCTCTTTGTGTTTGGTGGGGTCTTTCCACGTCCTAATCCTGAACCTGATGGCTGCAGCAATTTACTCTACATTTTTGATCCGCAACATGAGATTTGGTACCAGCCTATTGTCCTAGGAAAGACCCCTTCGTCACGCTCAGGGCACTCTGCCTGTCTGTTAAACAGAGAGCTGTATGTTTTTGGTGGATGGGATACTCCTGTTTGTTACAATGACCTCTACGTACTGGATCTGGGACTCATGGAGTTCTCTCTTGTTGAGGTCACAGGATCCTCACCCTCTCCTCGTTGCTGGCATTCTGCTGCCCCTGTGTCAGATTTCCAGTTCTTGATTCACGGAGGTTATGATGGAAACCAGGCTCTGAGTGACACCTACCTATTCAACACTGGAGCCCCTCTGCCACTGGCCAGAATCCACAGATCCAGTCCAGGCCTGCACTAACAGATTTTGGAGTACACCATACTGGGAACACTCCTCGCTACTACCGAAGGCCACACATTCTACATCAGCTGGAAGGGACTGTGCAGCAGGATCCAAGACTGTTGTTTTTTATTTAAAAACAATATGCATGGTTAAGAGCATTACTTTAGGTCAAAATGTTACCTGGTATAAATTGGCCTATCCTAACCAATTTGTTTTGTGTAACCAAAGCATATGATTAGGCGTATCCCTAACTTGTCT"
    ]

    return seqs

def test_genome_index(index_dir, loc_and_seq):
    from gimmemotifs.genome_index import GenomeIndex
    g = GenomeIndex(index_dir)
    
    loc, seq = loc_and_seq
    
    assert seq == g.get_sequence(*loc)

def test_get_transcript_sequence(collection, seqs):
    from pita.util import exons_to_seq

    model = [m for m in collection.get_best_variants([])][0]
    seq = sorted(seqs, cmp=lambda x,y: cmp(len(x), len(y)))[-1]
    assert seq.upper() == exons_to_seq(model).upper()
    
    

